<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .file-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .video-list {
            margin-top: 20px;
        }
        .video-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .video-item video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 5px;
        }
        .video-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .compression-info {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</h1>
        
        <div class="form-group">
            <label for="token">Token (‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ login):</label>
            <input type="text" id="token" placeholder="‡πÉ‡∏™‡πà JWT token ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
        </div>

        <div class="form-group">
            <label for="houseId">House ID:</label>
            <input type="text" id="houseId" placeholder="‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô">
        </div>

        <div class="form-group">
            <label for="quality">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î:</label>
            <select id="quality">
                <option value="low">‡∏ï‡πà‡∏≥ (500k bitrate) - ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
                <option value="medium" selected>‡∏Å‡∏•‡∏≤‡∏á (1000k bitrate) - ‡∏™‡∏°‡∏î‡∏∏‡∏•</option>
                <option value="high">‡∏™‡∏π‡∏á (2000k bitrate) - ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
            </select>
        </div>

        <div class="form-group">
            <label for="videos">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡πÑ‡∏ü‡∏•‡πå, ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500MB):</label>
            <input type="file" id="videos" multiple accept="video/*">
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>

        <button id="uploadBtn" onclick="uploadVideos()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="result" class="result"></div>

        <button id="loadVideosBtn" onclick="loadVideos()" style="background-color: #2196F3; margin-top: 20px;">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        
        <div id="videoList" class="video-list"></div>
    </div>

    <script>
        // ‡πÇ‡∏´‡∏•‡∏î token ‡∏à‡∏≤‡∏Å localStorage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
            }
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.getElementById('videos').addEventListener('change', function(e) {
            const files = e.target.files;
            const fileInfo = document.getElementById('fileInfo');
            
            if (files.length > 0) {
                let info = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ${files.length} ‡πÑ‡∏ü‡∏•‡πå:\n`;
                let totalSize = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    totalSize += file.size;
                    info += `${i + 1}. ${file.name} (${sizeMB} MB)\n`;
                }
                
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                info += `\n‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ß‡∏°: ${totalSizeMB} MB`;
                
                fileInfo.textContent = info;
                fileInfo.style.display = 'block';
            } else {
                fileInfo.style.display = 'none';
            }
        });

        async function uploadVideos() {
            const token = document.getElementById('token').value;
            const houseId = document.getElementById('houseId').value;
            const quality = document.getElementById('quality').value;
            const videosInput = document.getElementById('videos');
            const files = videosInput.files;

            if (!token) {
                showResult('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà token', 'error');
                return;
            }

            if (!houseId) {
                showResult('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà House ID', 'error');
                return;
            }

            if (!files || files.length === 0) {
                showResult('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠', 'error');
                return;
            }

            if (files.length > 5) {
                showResult('‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
            for (let file of files) {
                if (file.size > 500 * 1024 * 1024) { // 500MB
                    showResult(`‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500MB`, 'error');
                    return;
                }
            }

            const formData = new FormData();
            for (let file of files) {
                formData.append('videos', file);
            }
            formData.append('quality', quality);

            const uploadBtn = document.getElementById('uploadBtn');
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');

            uploadBtn.disabled = true;
            uploadBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î...';
            progress.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                    }
                });

                const response = await new Promise((resolve, reject) => {
                    xhr.onload = function() {
                        if (xhr.status === 200 || xhr.status === 201) {
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            reject(new Error(xhr.responseText));
                        }
                    };
                    xhr.onerror = function() {
                        reject(new Error('Network error'));
                    };

                    xhr.open('POST', `http://localhost:4000/v1/api/houses/${houseId}/videos`);
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    xhr.send(formData);
                });

                progressBar.style.width = '100%';
                
                if (response.success) {
                    const data = response.data;
                    let resultHtml = `
                        <h3>‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                        <div class="compression-info">
                            <strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î:</strong><br>
                            üìÅ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${data.totalFiles} ‡πÑ‡∏ü‡∏•‡πå<br>
                            üìä ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö: ${(data.totalOriginalSize / (1024 * 1024)).toFixed(2)} MB<br>
                            üóúÔ∏è ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î: ${(data.totalCompressedSize / (1024 * 1024)).toFixed(2)} MB<br>
                            üíæ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${data.averageCompressionRatio.toFixed(1)}%
                        </div>
                        <h4>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå:</h4>
                    `;
                    
                    data.videos.forEach((video, index) => {
                        resultHtml += `
                            <div class="video-item">
                                <strong>‡πÑ‡∏ü‡∏•‡πå ${index + 1}: ${video.filename}</strong><br>
                                ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö: ${(video.originalSize / (1024 * 1024)).toFixed(2)} MB<br>
                                ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î: ${(video.compressedSize / (1024 * 1024)).toFixed(2)} MB<br>
                                ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${video.compressionRatio}%
                                ${video.duration ? `<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß: ${video.duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ` : ''}
                                ${video.resolution ? `<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${video.resolution}` : ''}
                            </div>
                        `;
                    });
                    
                    showResult(resultHtml, 'success');
                    
                    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå form
                    videosInput.value = '';
                    document.getElementById('fileInfo').style.display = 'none';
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏´‡∏°‡πà
                    setTimeout(() => loadVideos(), 1000);
                } else {
                    showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + response.message, 'error');
                }

            } catch (error) {
                console.error('Upload error:', error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
                
                try {
                    const errorData = JSON.parse(error.message);
                    errorMessage = errorData.message || errorMessage;
                } catch {
                    errorMessage = error.message || errorMessage;
                }
                
                showResult(errorMessage, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠';
                progress.style.display = 'none';
            }
        }

        async function loadVideos() {
            const token = document.getElementById('token').value;
            const houseId = document.getElementById('houseId').value;

            if (!houseId) {
                showResult('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà House ID', 'error');
                return;
            }

            try {
                const response = await fetch(`http://localhost:4000/v1/api/houses/${houseId}/videos`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const videoList = document.getElementById('videoList');
                    
                    if (data.data.videos.length === 0) {
                        videoList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>';
                        return;
                    }

                    let html = `<h3>üìπ ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${data.data.totalVideos} ‡πÑ‡∏ü‡∏•‡πå)</h3>`;
                    
                    data.data.videos.forEach((video, index) => {
                        html += `
                            <div class="video-item">
                                <h4>‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ${index + 1}: ${video.filename}</h4>
                                <video controls>
                                    <source src="http://localhost:4000${video.url}" type="video/mp4">
                                    ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                                </video>
                                <div class="video-info">
                                    üìÅ ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: ${video.filename}<br>
                                    üîó URL: <a href="http://localhost:4000${video.url}" target="_blank">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</a>
                                    ${token ? `<br><button onclick="deleteVideo('${video.filename}')" style="background-color: #dc3545; margin-top: 10px;">‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ô‡∏µ‡πâ</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    videoList.innerHTML = html;
                } else {
                    showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message, 'error');
                }

            } catch (error) {
                console.error('Load videos error:', error);
                showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠: ' + error.message, 'error');
            }
        }

        async function deleteVideo(filename) {
            const token = document.getElementById('token').value;
            const houseId = document.getElementById('houseId').value;

            if (!token) {
                showResult('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠', 'error');
                return;
            }

            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ "${filename}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:4000/v1/api/houses/${houseId}/videos/${filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showResult('‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    loadVideos(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                } else {
                    showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message, 'error');
                }

            } catch (error) {
                console.error('Delete video error:', error);
                showResult('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠: ' + error.message, 'error');
            }
        }

        function showResult(message, type) {
            const result = document.getElementById('result');
            result.innerHTML = message;
            result.className = `result ${type}`;
            result.style.display = 'block';
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            result.scrollIntoView({ behavior: 'smooth' });
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å token ‡∏•‡∏á localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        document.getElementById('token').addEventListener('input', function(e) {
            if (e.target.value) {
                localStorage.setItem('token', e.target.value);
            }
        });
    </script>
</body>
</html>